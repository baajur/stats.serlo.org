version: 2

vars:
  dump_location: gs://serlo_dev_terraform/sql-dumps/dump-2019-05-13.zip

tasks:
  create: 
    desc: |
      *
        - ensures cluster is created
        - deploys the resources
        - launches the website
    cmds: 
      - task: minikube:create
      - task: deploy
      - task: launch

  start:
    desc: |
      *
        - ensures cluster is started
        - launches the website    
    cmds:
      - task: minikube:start
      - task: launch

  deploy:
    desc: |
      *
        - [minikube] builds the images in case they are not present in remote docker
        - applies the resources with terraform
    cmds:
      - task build:all
      - task terraform:apply
      - test -f tmp/dump.sql || mkdir -p tmp && echo "downloading latest mysql dump from gcloud" && gsutil cp {{.dump_location}} tmp/dump.zip
      - test -f tmp/dump.sql || unzip tmp/dump.zip -d tmp
      - bash scripts/setup-athene2-db.sh

  launch:
    desc: |
      *
        - launches the grafana web app
        - [minikube] basic auth user and password is serlo
    cmds:
      - xdg-open $grafana_host 2>/dev/null >/dev/null

